# XAMPP Virtual Host Configuration for Anoud Job Website
# Place this content in: C:\xampp\apache\conf\extra\httpd-vhosts.conf

# Enable mod_rewrite
LoadModule rewrite_module modules/mod_rewrite.so

# Enable mod_headers
LoadModule headers_module modules/mod_headers.so

# Enable mod_proxy
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so

# Main Virtual Host for Anoud Job Website
<VirtualHost *:80>
    ServerName anoudjob.local
    ServerAlias www.anoudjob.local
    DocumentRoot "C:/xampp/htdocs/anoudjob"
    
    # Enable rewrite engine
    RewriteEngine On
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS headers for API
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Handle preflight requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Proxy API requests to Node.js backend
    RewriteCond %{REQUEST_URI} ^/api/(.*)$
    RewriteRule ^/api/(.*)$ http://localhost:3234/api/$1 [P,L]
    
    # Handle React Router (SPA routing)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteRule ^(.*)$ /index.html [L]
    
    # Static file caching
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        Header append Cache-Control "public"
    </LocationMatch>
    
    # Gzip compression
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Error and access logs
    ErrorLog "C:/xampp/logs/anoudjob/error.log"
    CustomLog "C:/xampp/logs/anoudjob/access.log" combined
    
    # Directory permissions
    <Directory "C:/xampp/htdocs/anoudjob">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Security: Prevent access to sensitive files
        <FilesMatch "\.(env|log|md|txt)$">
            Require all denied
        </FilesMatch>
    </Directory>
</VirtualHost>

# HTTPS Virtual Host (if SSL is configured)
<VirtualHost *:443>
    ServerName anoudjob.local
    ServerAlias www.anoudjob.local
    DocumentRoot "C:/xampp/htdocs/anoudjob"
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile "C:/xampp/apache/conf/ssl.crt/server.crt"
    SSLCertificateKeyFile "C:/xampp/apache/conf/ssl.key/server.key"
    
    # Enable rewrite engine
    RewriteEngine On
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS headers for API
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Handle preflight requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Proxy API requests to Node.js backend
    RewriteCond %{REQUEST_URI} ^/api/(.*)$
    RewriteRule ^/api/(.*)$ http://localhost:3234/api/$1 [P,L]
    
    # Handle React Router (SPA routing)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteRule ^(.*)$ /index.html [L]
    
    # Static file caching
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        Header append Cache-Control "public"
    </LocationMatch>
    
    # Gzip compression
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Error and access logs
    ErrorLog "C:/xampp/logs/anoudjob/ssl-error.log"
    CustomLog "C:/xampp/logs/anoudjob/ssl-access.log" combined
    
    # Directory permissions
    <Directory "C:/xampp/htdocs/anoudjob">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Security: Prevent access to sensitive files
        <FilesMatch "\.(env|log|md|txt)$">
            Require all denied
        </FilesMatch>
    </Directory>
</VirtualHost>

# Redirect HTTP to HTTPS (uncomment if using SSL)
# <VirtualHost *:80>
#     ServerName anoudjob.local
#     ServerAlias www.anoudjob.local
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </VirtualHost>
